<?php

namespace App\Models;

use CodeIgniter\Model;

class SourceReportModel extends Model
{
    protected $table = 'khm_obj_enquiry_details';
    protected $primaryKey = 'enquiry_details_id';
    protected $returnType = 'array';
    protected $allowedFields = [
        'enquiry_header_id',
        'enquiry_source',
        'date_of_tour_start',
        'total_no_of_pax',
        'enq_description',

    ];


    protected function baseQuery()
    {
        // 1) subquery that finds the max status_id per header
        $latestStatusSub = $this->db
            ->table('khm_obj_enquiry_status')
            ->select([
                'enquiry_header_id',
                'MAX(enquiry_status_id) AS enquiry_status_id',
            ])
            ->groupBy('enquiry_header_id')
            ->getCompiledSelect();

        return $this->db
            ->table('khm_obj_enquiry_details AS ed')
            ->distinct()
            ->select([
                'eh.ref_no',
                'ed.enquiry_header_id',
                'ed.enquiry_source',
                'ed.date_of_tour_start',
                'ed.total_no_of_pax',
                'ed.enq_description',
                'om.object_name',
                'eh.enq_added_date',
                'mes.status_name',           // from latest status
            ])

            // join header
            ->join(
                'khm_obj_enquiry_header AS eh',
                'eh.enquiry_header_id = ed.enquiry_header_id',
                'left'
            )

            // join edit-request (fixed alias)
            ->join(
                'khm_obj_enquiry_edit_request AS er',
                'er.enquiry_header_id = eh.enquiry_header_id',
                'left'
            )

            // if you still need to filter edit-requests by an active flag, fix the column name here:
            // ->where('er.active_flag', 1)

            // join a “current‐status” filter if needed, alias it es_filter
            ->join(
                'khm_obj_enquiry_status AS es_filter',
                'es_filter.edit_request_id = er.enquiry_edit_request_id',
                'left'
            )
            ->where('es_filter.current_status_id', 1)

            // object master
            ->join(
                'khm_obj_mst AS om',
                'om.object_id = eh.object_id',
                'left'
            )

            // 2) join our “latest-status” subquery
            ->join(
                "($latestStatusSub) AS ls",
                'ls.enquiry_header_id = eh.enquiry_header_id',
                'left'
            )

            // 3) rejoin to get the full status row for that max ID
            ->join(
                'khm_obj_enquiry_status AS oes_latest',
                'oes_latest.enquiry_header_id = ls.enquiry_header_id
             AND oes_latest.enquiry_status_id = ls.enquiry_status_id',
                'left'
            )

            // 4) pull the human‐readable status name
            ->join(
                'khm_obj_mst_enquiry_status AS mes',
                'mes.status_id = oes_latest.enquiry_status_id',
                'left'
            )

            // filters on active flags
            ->where('eh.is_active', 1)
            ->where('ed.is_active', 1)
            // if you want only active statuses in your master:
            ->where('mes.is_active', 1)

            // final ordering
            ->orderBy('ed.enquiry_details_id', 'DESC');
    }



    public function getByDateRange(string $fromYmd, string $toYmd): array
    {
        return $this->baseQuery()
            ->where('eh.enq_added_date >=', $fromYmd)
            ->where('eh.enq_added_date <',  $toYmd)
            ->get()
            ->getResultArray();
    }

    public function getSourceReport(): array
    {
        // simply returns everything (no date filter)
        return $this->baseQuery()
            ->get()
            ->getResultArray();
    }
}
